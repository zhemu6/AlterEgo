# AlterEgo Backend - Agent Development Guide

## Project Overview
- **Project**: AlterEgo (异我) - AI Agent Digital Pet Social Platform
- **Tech Stack**: Java 21, Spring Boot 3.5.10, MyBatis-Plus, Redis, MySQL
- **Base Package**: `org.zhemu.alterego`
- **Context Path**: `/api`
- **Port**: 8124

---

## Build, Test & Run Commands

### Build & Run
```bash
# Clean and build
./mvnw clean package

# Run application (development profile)
./mvnw spring-boot:run

# Run with specific profile
./mvnw spring-boot:run -Dspring-boot.run.profiles=dev
./mvnw spring-boot:run -Dspring-boot.run.profiles=prod

# Build without tests
./mvnw clean package -DskipTests
```

### Testing
```bash
# Run all tests
./mvnw test

# Run a single test class
./mvnw test -Dtest=BackendApplicationTests

# Run a specific test method
./mvnw test -Dtest=BackendApplicationTests#contextLoads

# Run tests with coverage
./mvnw clean test jacoco:report

# Skip tests during build
./mvnw clean install -DskipTests
```

### Code Quality
```bash
# Compile (includes Lombok annotation processing)
./mvnw compile

# Verify build
./mvnw verify
```

---

## Project Structure

```
src/
├── main/
│   ├── java/org/zhemu/alterego/
│   │   ├── BackendApplication.java         # Main application entry
│   │   ├── config/                         # Configuration classes
│   │   │   ├── CorsConfig.java            # CORS & Interceptor config
│   │   │   └── JsonConfig.java            # JSON serialization config
│   │   ├── controller/                     # REST Controllers (create here)
│   │   ├── service/                        # Business logic services (create here)
│   │   ├── mapper/                         # MyBatis-Plus mappers (create here)
│   │   ├── entity/                         # Database entities (create here)
│   │   ├── dto/                           # Data Transfer Objects (create here)
│   │   ├── common/                        # Common utilities/constants (create here)
│   │   ├── exception/                     # Custom exceptions (create here)
│   │   └── aop/                           # AOP interceptors (create here)
│   └── resources/
│       ├── application.yml                 # Main config
│       ├── application-dev.yml            # Dev environment config
│       └── application-prod.yml           # Production config
└── test/
    └── java/org/zhemu/alterego/           # Test classes
```

---

## Code Style Guidelines

### Package Naming
- Use lowercase: `org.zhemu.alterego.controller`
- Follow domain structure: `controller`, `service`, `mapper`, `entity`, `dto`, `config`, `exception`, `common`, `aop`

### Class Naming
- Controllers: `*Controller` (e.g., `UserController`, `PostController`)
- Services: `*Service` (e.g., `UserService`, `PostService`)
- Service Implementations: `*ServiceImpl` (e.g., `UserServiceImpl`)
- Mappers: `*Mapper` (e.g., `UserMapper`, `PostMapper`)
- Entities: Plain names (e.g., `User`, `Post`, `Agent`)
- DTOs: `*Request`, `*Response`, `*DTO` (e.g., `CreateAgentRequest`, `PostResponse`)
- Exceptions: `*Exception` (e.g., `BusinessException`, `NotFoundException`)
- Config: `*Config` (e.g., `CorsConfig`, `RedisConfig`)

### Import Organization
```java
// 1. Java standard library
import java.util.List;
import java.time.LocalDateTime;

// 2. Third-party libraries (Spring, MyBatis, etc.)
import org.springframework.stereotype.Service;
import com.baomidou.mybatisplus.core.mapper.BaseMapper;

// 3. Project internal imports
import org.zhemu.alterego.entity.User;
import org.zhemu.alterego.mapper.UserMapper;

// 4. Static imports (if any)
import static org.junit.jupiter.api.Assertions.*;
```

### Annotation Order
```java
// Class annotations
@RestController          // Spring stereotype
@RequestMapping("/api")  // Mapping
@RequiredArgsConstructor // Lombok
@Slf4j                  // Lombok logging
public class UserController {
    
    // Field annotations
    private final UserService userService;
    
    // Method annotations
    @GetMapping("/{id}")  // HTTP method mapping
    @ApiOperation("...")  // API documentation (if using Knife4j)
    public ResponseEntity<User> getUser(@PathVariable Long id) {
        // ...
    }
}
```

### Dependency Injection
**Use constructor injection with Lombok** (preferred):
```java
@Service
@RequiredArgsConstructor  // Generates constructor for final fields
@Slf4j
public class UserService {
    private final UserMapper userMapper;
    private final RedisTemplate<String, Object> redisTemplate;
    
    // Constructor automatically generated by Lombok
}
```

**Alternative (without Lombok)**:
```java
@Service
public class UserService {
    private final UserMapper userMapper;
    
    public UserService(UserMapper userMapper) {
        this.userMapper = userMapper;
    }
}
```

**Avoid field injection**:
```java
// ❌ DON'T DO THIS
@Autowired
private UserMapper userMapper;
```

### Naming Conventions
- **Classes**: PascalCase (`UserController`, `PostService`)
- **Methods**: camelCase (`getUserById`, `createPost`)
- **Variables**: camelCase (`userId`, `userName`)
- **Constants**: UPPER_SNAKE_CASE (`MAX_RETRY_COUNT`, `DEFAULT_PAGE_SIZE`)
- **Database tables**: snake_case (`sys_user`, `post_table`)
- **Database columns**: snake_case (`user_id`, `create_time`)
- **JSON fields**: camelCase (automatically handled by Jackson)

### Type Handling
- Use `Long` for IDs (not `long` - nullable for proper handling)
- JSON serialization: Long → String (configured in `JsonConfig.java`)
- Database: `bigint` columns map to `Long` in Java
- Dates: Use `LocalDateTime` (not `Date` or `Timestamp`)
- Status codes: Use `enum` types when possible

### Lombok Usage
**Commonly used Lombok annotations**:
```java
@Data                    // Generates getters, setters, toString, equals, hashCode
@NoArgsConstructor       // Generates no-args constructor
@AllArgsConstructor      // Generates all-args constructor
@Builder                 // Builder pattern
@RequiredArgsConstructor // Constructor for final fields
@Slf4j                   // Logger instance: log.info(), log.error(), etc.

// Entity example
@Data
@TableName("sys_user")  // MyBatis-Plus
public class User {
    @TableId(type = IdType.AUTO)
    private Long id;
    private String userName;
    private LocalDateTime createTime;
    
    @TableLogic  // MyBatis-Plus logical delete
    private Integer isDelete;
}
```

---

## MyBatis-Plus Patterns

### Entity Classes
```java
package org.zhemu.alterego.entity;

import com.baomidou.mybatisplus.annotation.*;
import lombok.Data;
import java.time.LocalDateTime;

@Data
@TableName("sys_user")  // Database table name
public class User {
    @TableId(type = IdType.AUTO)  // Auto-increment ID
    private Long id;
    
    private String userAccount;
    private String userPassword;
    private String userName;
    private String userAvatar;
    private String userProfile;
    private String userRole;
    private Integer userStatus;
    private String email;
    
    @TableField(fill = FieldFill.INSERT)  // Auto-fill on insert
    private LocalDateTime createTime;
    
    @TableField(fill = FieldFill.INSERT_UPDATE)  // Auto-fill on insert/update
    private LocalDateTime updateTime;
    
    @TableLogic  // Logical delete: 0=not deleted, 1=deleted
    private Integer isDelete;
}
```

### Mapper Interfaces
```java
package org.zhemu.alterego.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import org.apache.ibatis.annotations.Mapper;
import org.zhemu.alterego.entity.User;

@Mapper
public interface UserMapper extends BaseMapper<User> {
    // BaseMapper provides: selectById, insert, updateById, deleteById, etc.
    
    // Add custom queries if needed
    // User selectByUserAccount(String userAccount);
}
```

### Service Layer
```java
package org.zhemu.alterego.service;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.zhemu.alterego.entity.User;
import org.zhemu.alterego.mapper.UserMapper;

@Service
@RequiredArgsConstructor
@Slf4j
public class UserService {
    private final UserMapper userMapper;
    
    public User getUserById(Long id) {
        log.info("Getting user by id: {}", id);
        return userMapper.selectById(id);
    }
    
    public User getUserByAccount(String userAccount) {
        QueryWrapper<User> wrapper = new QueryWrapper<>();
        wrapper.eq("user_account", userAccount);
        return userMapper.selectOne(wrapper);
    }
    
    public Long createUser(User user) {
        log.info("Creating user: {}", user.getUserAccount());
        userMapper.insert(user);
        return user.getId();  // ID is set after insert
    }
}
```

---

## Controller Patterns

### REST Controller Template
```java
package org.zhemu.alterego.controller;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.web.bind.annotation.*;
import org.zhemu.alterego.entity.User;
import org.zhemu.alterego.service.UserService;

@RestController
@RequestMapping("/user")
@RequiredArgsConstructor
@Slf4j
public class UserController {
    private final UserService userService;
    
    @GetMapping("/{id}")
    public User getUser(@PathVariable Long id) {
        log.info("GET /user/{}", id);
        return userService.getUserById(id);
    }
    
    @PostMapping
    public Long createUser(@RequestBody User user) {
        log.info("POST /user: {}", user.getUserAccount());
        return userService.createUser(user);
    }
    
    @PutMapping("/{id}")
    public void updateUser(@PathVariable Long id, @RequestBody User user) {
        log.info("PUT /user/{}", id);
        user.setId(id);
        userService.updateUser(user);
    }
    
    @DeleteMapping("/{id}")
    public void deleteUser(@PathVariable Long id) {
        log.info("DELETE /user/{}", id);
        userService.deleteUser(id);
    }
}
```

---

## Error Handling

### Custom Business Exception
```java
package org.zhemu.alterego.exception;

public class BusinessException extends RuntimeException {
    private final int code;
    
    public BusinessException(int code, String message) {
        super(message);
        this.code = code;
    }
    
    public BusinessException(String message) {
        this(400, message);
    }
    
    public int getCode() {
        return code;
    }
}
```

### Global Exception Handler (Recommended)
```java
package org.zhemu.alterego.config;

import lombok.extern.slf4j.Slf4j;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;
import org.zhemu.alterego.exception.BusinessException;

@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {
    
    @ExceptionHandler(BusinessException.class)
    public ResponseEntity<?> handleBusinessException(BusinessException e) {
        log.warn("Business exception: {}", e.getMessage());
        return ResponseEntity.status(e.getCode()).body(e.getMessage());
    }
    
    @ExceptionHandler(Exception.class)
    public ResponseEntity<?> handleException(Exception e) {
        log.error("Unexpected exception", e);
        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                .body("Internal server error");
    }
}
```

---

## Logging Patterns

### Use SLF4J with Lombok
```java
@Service
@Slf4j  // Creates: private static final Logger log = LoggerFactory.getLogger(...)
public class MyService {
    
    public void doSomething(String param) {
        log.info("Starting operation with param: {}", param);  // ✅ Parameterized
        log.debug("Debug details: {}", someDetails);
        
        try {
            // operation
            log.info("Operation completed successfully");
        } catch (Exception e) {
            log.error("Operation failed: {}", e.getMessage(), e);  // ✅ Include exception
        }
    }
}
```

### Logging Best Practices
- Use `log.info()` for important business operations
- Use `log.debug()` for detailed debugging info
- Use `log.warn()` for recoverable issues
- Use `log.error()` for exceptions and errors
- **Always use parameterized logging**: `log.info("User {}", userId)` not `log.info("User " + userId)`
- **Never log sensitive data**: passwords, tokens, API keys
- **Include exception object**: `log.error("Message", exception)` not just `exception.getMessage()`
- **Avoid `System.out.println()`**: use proper logging

---

## Testing Guidelines

### Test Class Structure
```java
package org.zhemu.alterego;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;
import static org.junit.jupiter.api.Assertions.*;

@SpringBootTest  // JUnit 5 + Spring Boot integration test
class UserServiceTests {
    
    @Test
    void testGetUserById() {
        // Arrange
        Long userId = 1L;
        
        // Act
        User user = userService.getUserById(userId);
        
        // Assert
        assertNotNull(user);
        assertEquals(userId, user.getId());
    }
}
```

### Testing Framework
- **Framework**: JUnit 5 (Jupiter)
- **Annotations**: `@Test`, `@SpringBootTest`, `@WebMvcTest`, `@DataJpaTest`
- **Assertions**: `org.junit.jupiter.api.Assertions.*`
- **Mocking**: Use Mockito when needed (`@Mock`, `@MockBean`)

---

## Configuration Files

### Application Profiles
- `application.yml`: Main configuration (active profile selection)
- `application-dev.yml`: Development environment settings
- `application-prod.yml`: Production environment settings

### Important Settings
- **Database**: Configure in `application-dev.yml`/`application-prod.yml`
- **MyBatis-Plus**: 
  - Camel case mapping: enabled
  - Logical delete field: `isDelete`
  - Logical delete values: 0=active, 1=deleted
- **API Documentation**: Knife4j enabled at `/doc.html`

---

## Common Commands Reference

```bash
# Development
./mvnw spring-boot:run                           # Run application
./mvnw spring-boot:run -Dspring-boot.run.profiles=dev

# Testing
./mvnw test                                      # Run all tests
./mvnw test -Dtest=ClassName                     # Run single test class
./mvnw test -Dtest=ClassName#methodName          # Run single test method

# Building
./mvnw clean package                             # Build JAR
./mvnw clean install                             # Install to local Maven repo
./mvnw clean package -DskipTests                 # Build without tests

# Dependency Management
./mvnw dependency:tree                           # Show dependency tree
./mvnw dependency:analyze                        # Analyze dependencies
```

---

## Key Dependencies & Versions

- **Java**: 21
- **Spring Boot**: 3.5.10
- **MyBatis-Plus**: 3.5.10.1
- **Hutool**: 5.8.37 (Chinese utility library)
- **Knife4j**: 4.4.0 (API documentation)
- **Lombok**: Provided by Spring Boot parent
- **AgentScope Java**: 1.0.8
- **Redis**: Spring Data Redis
- **RabbitMQ**: Spring AMQP

---

## Notes for AI Agents

1. **Always use Lombok**: Prefer `@RequiredArgsConstructor` + final fields over `@Autowired`
2. **Package naming mismatch**: Some config files have incorrect package (`com.zhemu.paperinsight` instead of `org.zhemu.alterego`) - fix when editing
3. **ID serialization**: Long IDs are serialized to String in JSON (see `JsonConfig.java`)
4. **Logical deletion**: Use `@TableLogic` on `isDelete` field for soft deletes
5. **Chinese comments**: Project uses Chinese comments - maintain consistency or ask before changing
6. **API prefix**: All endpoints are prefixed with `/api` (configured in `application.yml`)
7. **CORS**: Cross-origin requests are allowed (see `CorsConfig.java`)
